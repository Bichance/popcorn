<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="spring.mapper.popcorn.QnaMapper">

	<!-- LIST -->
	
	<select id="list" parameterType="Map" resultType="QnaDTO">
		SELECT qna_num, id, qna_title, qna_type,
		qna_date, qna_grpno, qna_indent, qna_ansnum, r
		from(
		SELECT qna_num, id, qna_title, qna_type,
		qna_date, qna_grpno, qna_indent, qna_ansnum, rownum r
		from(
		select qna_num, id, qna_title, qna_type, to_char(qna_date, 'yyyy-mm-dd')
		qna_date, qna_grpno, qna_indent, qna_ansnum
		from qna
		<where>
			<choose>
				<when test="col=='id'">
					id like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_title'">
					qna_title like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_content'">
					qna_content like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_title_qna_content'">
					qna_content like '%'||#{word}||'%'
					or qna_title like '%'||#{word}||'%'
				</when>
			</choose>
		</where>
		order by qna_grpno desc, qna_ansnum
		)
		)
		<![CDATA[
		where r>=#{sno} and r<=#{eno} 
		]]>
	</select>
	
	<!--  TOTAL  -->
	
	<select id="total" parameterType="Map" resultType="int">
		select count(*)
		from qna
		<where>
			<choose>
				<when test="col=='id'">
					id like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_title'">
					qna_title like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_content'">
					qna_content like '%'||#{word}||'%'
				</when>
				<when test="col=='qna_title_qna_content'">
					qna_content like '%'||#{word}||'%'
					or qna_title like '%'||#{word}||'%'
				</when>
			</choose>
		</where>
	</select>
	
	
	<!--  CRUD  -->
	
	<!-- CREATE -->
	
	<insert id="create" parameterType="QnaDTO">
		insert into qna(qna_num, qna_title, qna_content, qna_date, qna_type, qna_pw, qna_grpno, id)
		values((select nvl(Max(qna_num),0)+1 as qna_num	from qna), #{qna_title}, #{qna_content}, sysdate, #{qna_type}, #{qna_pw}, (select nvl(Max(qna_grpno), 0)+1 as qna_grpno from qna), #{id})
	</insert>
	
	<!-- READ -->
	
	<select id="read" parameterType="int" resultType="QnaDTO">
		select qna_num, qna_title, qna_content, to_char(qna_date,'yyyy-mm-dd')
		qna_date, qna_type, qna_grpno, qna_indent, qna_ansnum, qna_refnum
		from qna
		where qna_num = #{qna_num}
	</select>
	
	<!--  UPDATE  -->
	
	<update id="update" parameterType="QnaDTO">
		update qna
		set qna_title=#{qna_title}, qna_content=#{qna_content},
		qna_type=#{qna_type}
		where qna_num= #{qna_num}
	</update>
	
	<!--  DELETE  -->

	<delete id="delete" parameterType="int">
		delete from qna
		where qna_num = #{qna_num}
	</delete>
	
	
	
	<!-- 답변 관련  -->
	
	<!-- CREATE REPLY -->
	
	<insert id="createReply" parameterType="QnaDTO">
		insert into qna(qna_num, id, qna_title, qna_content, qna_pw,
		qna_date, qna_grpno, qna_indent, qna_ansnum, qna_refnum)
		values((select nvl(Max(qna_num),0)+1 as qna_num
		from qna),
		#{id}, #{qna_title}, #{qna_content}, #{qna_pw}, sysdate, #{qna_grpno},
		#{qna_indent}+1, #{qna_ansnum}+1, #{qna_num} )
	</insert>
	
	<!-- READ REPLY -->

	<select id="readReply" parameterType="int" resultType="QnaDTO">
		select qna_num, qna_grpno, qna_title, qna_indent, qna_ansnum
		from qna
		where qna_num = #{qna_num}
	</select>
	
	<!-- REF NUMBER CHECK  -->
	<!-- 부모글인지 체크하기 위한 refnum -->

	<select id="refnumCheck" parameterType="int" resultType="int">
		select count(*) from qna
		where qna_refnum = #{qna_num}
	</select>
	
	<!-- UP ANSWER NUMBER  -->
	
	<update id="upAnsnum" parameterType="Map">
		update qna
		set qna_ansnum = qna_ansnum+1 
		where qna_grpno = #{qna_grpno}
		and qna_ansnum > #{qna_ansnum}
	</update>
	
	<!--  PASSWORD CHECK  -->
	
	<select id="passCheck" parameterType="Map" resultType="int">
		select count(qna_num) as cnt
		from qna
		where qna_num=#{qna_num} and qna_pw=#{qna_pw}
	</select>
	
	<!-- 조회수 증가  -->
	<!--  UP VIEW COUNT  -->

	<update id="upViewcnt" parameterType="int">
		update qna set
		qna_viewcnt = qna_viewcnt + 1
		where qna_num = #{qna_num}
	</update>
	
</mapper>